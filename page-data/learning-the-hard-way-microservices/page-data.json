{"componentChunkName":"component---src-templates-blog-post-js","path":"/learning-the-hard-way-microservices/","result":{"data":{"site":{"siteMetadata":{"title":"Not A Blog","author":"Andrew van Rooyen"}},"markdownRemark":{"id":"8fe63ed5-cca2-5ce7-9fc8-44860750a87a","excerpt":"In late 2016, my team and I started building a brand new platform. Having a\nblank slate like this is a developer’s dream — no legacy code, no backward…","html":"<p>In late 2016, my team and I started building a brand new platform. Having a\nblank slate like this is a developer’s dream — no legacy code, no backward\ncompatibility to worry about, and best of all, we could choose The Right\nTechnology™ for the job.</p>\n<p>Three years later, after much pain and suffering, I’m here to do a bit of a\nretrospective. Before diving in though, I’m going to acknowledge two things.</p>\n<ul>\n<li>Hindsight is 20/20</li>\n<li>There is no silver bullet</li>\n</ul>\n<p>There’s no way of knowing if doing things differently would have resulted in\nless frustration, but there were definitely some key pieces of <em>very important</em>\nadvice around domain/architecture which we chose to ignore. At the time, we\nthought we knew better.</p>\n<p>So for those who are embarking on similar journeys, here are some of the\nbiggest pieces of advice I regret not taking.</p>\n<h2>Ignored advice #1: Conway’s Law</h2>\n<p><a href=\"https://en.wikipedia.org/wiki/Conway%27s_law\">This law</a> states that\ninevitably, your system’s architecture will in some way resemble the\norganisational structure of your company.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 1000px;\"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 30.73666384419983%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAGCAYAAADDl76dAAAACXBIWXMAAAsSAAALEgHS3X78AAAAmElEQVQY042QwQrCQAxEsyq1tVXUVm314kHx6K0g6MH//6lO4BXXIurAgyXZnUzW7KVcbOxd4QOxZuIgtsNHrrs4iZH9rwVmjRjHjTlmpVhS80sX6s5ZHMVNXLmzEgXGeW9WDCK7aSomIuOcck7EmqFe20fvavr2YEIgtiepfqzqw3b8+RQaatZi2Kd90ghfDBPMakJkbFZ2xgQFkv6YwawAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Conway’s law\"\n        title=\"Conway’s law\"\n        src=\"/static/96005927a7675a35468d4e14b80d7208/e11df/conway.png\"\n        srcset=\"/static/96005927a7675a35468d4e14b80d7208/5039d/conway.png 250w,\n/static/96005927a7675a35468d4e14b80d7208/d19c0/conway.png 500w,\n/static/96005927a7675a35468d4e14b80d7208/e11df/conway.png 1000w,\n/static/96005927a7675a35468d4e14b80d7208/6ecc2/conway.png 1181w\"\n        sizes=\"(max-width: 1000px) 100vw, 1000px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n    </span></p>\n<p>As our platform has evolved, we’ve written and operated between 30 and 40\nmicroservices, depending on how you count. Not all still exist, some have been\nrewritten in a different language, etc.</p>\n<p>The catch is that since we started building, we were never more than a handful\nof backend developers. Because we were always a small, close-knit team, each\ndeveloper would work on all the services. Architecture decisions were made as a\ngroup, and being on call meant dealing with potential issues in any area.</p>\n<p>As you can probably guess from the high service-developer ratio, we ended up\nwith lots of “separated” yet tightly-coupled services. This hurt us a lot.</p>\n<p>Because of the coupling, there was an incessant temptation to reduce our\nworkload by “just” deploying cross-service changes at the same time, which\nflies in the face of the <a href=\"https://youtu.be/PFQnNFe27kU?t=1352\">deploy\nindependently</a> principle.</p>\n<h2>Ignored advice #2: You aren’t Google</h2>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 1000px;\"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 56.3%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAAAsSAAALEgHS3X78AAABAUlEQVQoz2NgAALHli+MINqh7aucU8vn+MNB8Wn/ZzEmRc7fW9ZYWDPxvyqXEVBaXIiVRRxIswIxBwMhEF91CUzbtX1n+2KpyfJ/GQOLW8cblaiqa4JgCU5RFiCpBcQ6QKwAxCI4DXPo+MKg1vefwaT9P3YFa+Di7EAsAWWr4DSQW0wLTHOJqjPwy1sydptYMvzfwsDg2f2IMa1iA8N8hFJQ0CgBMSgIeBgoBIxQ2hyIM4nVxAX1CgsOeZB3jUGhBMSqaBZhBaAwkgNiJhzyIG/KQ13JjkcdCgDZzInHy4ZA7ERKWIG8LIZDTgCItaHJRoacCEAHoLQnBMRsxIYhxQAArKUs0mG8a8QAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"You vs Google\"\n        title=\"You vs Google\"\n        src=\"/static/f140b791d819236355eaa1387e173d1a/e11df/notgoogle_1.png\"\n        srcset=\"/static/f140b791d819236355eaa1387e173d1a/5039d/notgoogle_1.png 250w,\n/static/f140b791d819236355eaa1387e173d1a/d19c0/notgoogle_1.png 500w,\n/static/f140b791d819236355eaa1387e173d1a/e11df/notgoogle_1.png 1000w\"\n        sizes=\"(max-width: 1000px) 100vw, 1000px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n    </span></p>\n<p>One of the lesser benefits of microservices is that they can scale\nindependently. In our initial design, we had already separated components which\nwere expected to be bottlenecks at scale. Reality check: It turns out the scale\nwhere this would matter is way beyond anything we are likely to encounter.</p>\n<p>In fact, not only were we guessing about domain boundaries, but each service\nalso came with a certain amount of overhead. We run a collection of sidecar\ncontainers and <a href=\"https://kubernetes.io/docs/concepts/workloads/controllers/daemonset/\">Kubernetes\nDaemonsets</a>\nfor operations functions (like monitoring and logging). It got to a point where\nwe were spending more resources on the supporting infrastructure than our\nactual application. By a large amount.</p>\n<p>Now, I’m not saying we’d be better off with a monolith, but if we had started\nwith a simpler architecture, we could have:</p>\n<ul>\n<li>Broken off pieces as we became more confident in the domain and found the\nright abstractions</li>\n<li>Gathered data around where the real performance bottlenecks were, if that\neven became a problem</li>\n<li>Saved a bunch of money by overlapping the supporting infrastructure</li>\n</ul>\n<h2>Ignored advice #3: You still aren’t Google</h2>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 1000px;\"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 56.3%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAAAsSAAALEgHS3X78AAAA+ElEQVQoz2NgAALrjt9GvrUvkl/4Gqd93SSU6tR7v2FZul/rPj52eaC0DDczkxCQZgZiRiiNHxj0/mf0r37C8t+egWXnkmgOp9aPmnOKlrBqMDCwMDCysAOViAKxLhArALEiEHPjNMyi4x8DkUAKiHmhrlTAq9Jl/n8G64SNDKESXIwhLpKMan5dTFMz0hhawbKMMGWcQCwHxHpALA0VY2SgEIDCzw2II4CYlZBikG2qQKwG9RI222WgYegHdTFBwAXVxEMgLC2gbCZiDFUGYjYcPgABIyB2JCX8lKDJBBsQAGJtaJDIkBL4uGwXAWIhqA9UqRXTeAEAR3ElisUazx0AAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"You vs Google\"\n        title=\"You vs Google\"\n        src=\"/static/f087604f4ae0cac56404986e977d158a/e11df/notgoogle_2.png\"\n        srcset=\"/static/f087604f4ae0cac56404986e977d158a/5039d/notgoogle_2.png 250w,\n/static/f087604f4ae0cac56404986e977d158a/d19c0/notgoogle_2.png 500w,\n/static/f087604f4ae0cac56404986e977d158a/e11df/notgoogle_2.png 1000w\"\n        sizes=\"(max-width: 1000px) 100vw, 1000px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n    </span></p>\n<p>Another benefit of microservices is the freedom to choose the best tool for the\njob. We were experimenting with languages, and were running services written in\n<a href=\"https://www.python.org/\">Python</a>, <a href=\"https://nodejs.org/en/\">NodeJS</a> and\n<a href=\"https://golang.org\">Golang</a>. This was great in general, but became a nightmare\nwhen writing shared libraries, since the same code had to be implemented in\nthree different languages.</p>\n<p>I do believe in experimenting with different tools, but we ended up treating\neverything as production-ready and long-lived. If you’re writing internal\nshared libraries, the services using them are no longer an experiment.</p>\n<p>I’ve had to come to terms with settling down with a single language. It turns\nout that’s totally OK. Experiment as much as possible, but having a primary\nstack which is repeatable and consistent is valuable too. This is even more\ntrue if your services all operate under the same umbrella (e.g., web server\nwith database connection).</p>\n<h2>Ignored advice #4: Everything is a trade-off</h2>\n<p>It turns out that a microservice architecture has a <strong>lot</strong> of downsides. I\nwon’t go into them here (others have <a href=\"https://martinfowler.com/articles/microservice-trade-offs.html\">already done\nthat</a>), but I\nthink it’s important to understand what you are signing up for.</p>\n<p>If we had sat down and looked into the pros and cons, we would probably have\nfound that it would only start being worth it as we grew into multiple backend\nteams, using different software to solve different problems.</p>\n<p><figure class=\"gatsby-resp-image-figure\" style=\"\">\n    <span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 1000px;\"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 43.24999999999999%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAIAAAC9o5sfAAAACXBIWXMAAAsSAAALEgHS3X78AAABIElEQVQoz51Ry0oDQRDcD/bq1aPf4MmP8CBBDCQmUbwpIXpzMYd1s4/Jzkz39Lx21k4UhCiCVkNTPdMFRXXmvR/+gsQ1DJLUzXqWGWP+IZ6vb0cvVxki8pRS6hkp7Ulistvbzx8Kxm4h9kzQ4kP5uDFVpqTEtuX3Togiz0Pfg2ih61hVVAUaZL1EyV2DFlIEH4w1FCmmmNVVpTclIBqtsanJedpuSSlrXaNaMMhfLQiyFgkb2YAG7goU+8pgb9sxEJJWUaneUkJkMpBNhokcAKJovZTeObZdNqXoBJOvwNiYK0uaT8J4FBdTfzeL07GfXNP9wj4t6TUP36I9TNu9FXh5oU9P4PgIzs/s8yqwtRg/kzsQ/3hnX1e0WvYx/H62dxPPBf8nugJTAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"The journey to net-positive value\"\n        title=\"The journey to\nnet-positive value\"\n        src=\"/static/b8b61f53c42a101608e1077011eaf5e9/e11df/value_graph.png\"\n        srcset=\"/static/b8b61f53c42a101608e1077011eaf5e9/5039d/value_graph.png 250w,\n/static/b8b61f53c42a101608e1077011eaf5e9/d19c0/value_graph.png 500w,\n/static/b8b61f53c42a101608e1077011eaf5e9/e11df/value_graph.png 1000w,\n/static/b8b61f53c42a101608e1077011eaf5e9/8e846/value_graph.png 1500w,\n/static/b8b61f53c42a101608e1077011eaf5e9/d40c8/value_graph.png 2000w\"\n        sizes=\"(max-width: 1000px) 100vw, 1000px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n    </span>\n    <figcaption class=\"gatsby-resp-image-figcaption\">The journey to\nnet-positive value</figcaption>\n  </figure></p>\n<h2>The punishment</h2>\n<p>We’ve spent time and effort going back the way we came. In January 2019, we\ntook a step back and looked for the biggest knot in our architecture. We\nidentified ten services which were coupled so tightly that bumping a single one\nwould collapse them all like a house of cards. We have since merged all ten to\nbe a single service, and haven’t looked back.</p>\n<p>We’ve also slowly phased out our Python services, and all but one of our Golang\nservices. In some cases this has meant literal rewrites into NodeJS. We’re left\nwith a single set of shared JavaScript libraries to maintain.</p>\n<h2>Learnings</h2>\n<p>If I could go back in time and give myself some warnings, I would say the\nfollowing:</p>\n<ul>\n<li>Design for the problems you know you have, and be very meticulous when\nguessing about the future.</li>\n<li>It’s safer to start with a few larger services and carve them up as the\nboundaries reveal themselves. A good rule of thumb is that one microservice\nis better than two unless you can articulate the reason for splitting them.\nOf course, there <em>are</em> many valid reasons, but make sure you know how they\napply before going ahead.</li>\n<li>When experimenting and building MVP services, be very clear about what you\n<em>won’t</em> do and stick to that. It’s easy to get trapped into maintaining\nsomething which isn’t the right solution.</li>\n</ul>","frontmatter":{"title":"Learning the hard way: Microservices","banner":{"publicURL":"/static/banner-bbc11fdad4c4320b474e14cd99a9c0c9.png"},"date":"September 02, 2019"}}},"pageContext":{"slug":"/learning-the-hard-way-microservices/","previous":{"fields":{"slug":"/a-rant-about-alt-tab-in-elementary-os/"},"frontmatter":{"title":"A rant about alt+tab in elementary OS"}},"next":null}}}