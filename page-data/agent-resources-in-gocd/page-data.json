{"componentChunkName":"component---src-templates-blog-post-js","path":"/agent-resources-in-gocd/","result":{"data":{"site":{"siteMetadata":{"title":"Not A Blog","author":"Andrew van Rooyen"}},"markdownRemark":{"id":"0afcac8b-fe32-5bae-8fa2-d821a2048bf9","excerpt":"Lately I’ve been working with GoCD. It’s an open-source continuous integration\ntool which has both driven me crazy and blown my mind in countless ways over\nthe…","html":"<p>Lately I’ve been working with GoCD. It’s an open-source continuous integration\ntool which has both driven me crazy and blown my mind in countless ways over\nthe past 8 months or so. It isn’t as well-known as Jenkins or Travis, but some\nof its core principles are fundamentally different to (and in my opinion,\nbetter than) any other CI tool I’m aware of.</p>\n<p><figure class=\"gatsby-resp-image-figure\" style=\"\">\n    <span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 590px;\"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 67.38578680203045%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAANCAIAAAAmMtkJAAAACXBIWXMAAAsSAAALEgHS3X78AAABeklEQVQoz32SW3ObMBCF/f//WN7aTKbjaSYhBYMBY6MLqwtaSbvFuHab1u4ZiYeVvtnD0W6YOWAahRrFaA2gs2BMTpjQAZiYop2tcy6HbMECADOt66wN3xPR/fIvLM0c7UP4gVZywfQ7IzyElYn/gHnBaJYENSdP/7E9SOTbn12UkXTB6jvjdHOxsdamlD47424MCuIfJWIKNH34OcxIvUS9Wtt473POf3UWE1b9cvNcT8Szg2NXi1FJk4SKUFazlA9tO2Rl0yBjN8ah3XVNYz1NPpvO6ucavu2yC1d4eZnbWmUkcESmFKYu2HHNK9vygPUBJz04ESLe75yNho8i9k0snvJQkDxkLWBbJmECh94PkSJdAls2gphev/i6MkMTjnvX79VRoG5QNgjGC6WrkxFWxUl4EVK4DcsZPvVt/bp9//pSFdvq7WVflvWPYle+tW0/DMdm37an7qAPJzUu6Vpznlaia+dL2pl+Dyath/RZy7Xlu7wrXaP5CcDe9OyxBCE5AAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"CI tool comparison\"\n        title=\"Google searches for popular CI\ntools\"\n        src=\"/static/951c09807ba3a8aa3b5b3de5674d2a72/b9e4f/interest-graph.png\"\n        srcset=\"/static/951c09807ba3a8aa3b5b3de5674d2a72/cf440/interest-graph.png 148w,\n/static/951c09807ba3a8aa3b5b3de5674d2a72/d2d38/interest-graph.png 295w,\n/static/951c09807ba3a8aa3b5b3de5674d2a72/b9e4f/interest-graph.png 590w,\n/static/951c09807ba3a8aa3b5b3de5674d2a72/993a7/interest-graph.png 788w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        loading=\"lazy\"\n      />\n    </span>\n    <figcaption class=\"gatsby-resp-image-figcaption\">Google searches for popular CI\ntools</figcaption>\n  </figure></p>\n<p>The graph above paints a pretty accurate picture of this space. A few years\nago, everyone (including us) was using Jenkins. There has been some effort to\nimprove Jenkins (e.g. by adding a plugin for pipelines), but it has pretty much\nbeen succeeded by Travis. Circle CI is also proving to be a dominant force, and\nseems to be the service which is attracting all the cool kids.</p>\n<p>Having moved to GoCD, I don’t regret the decision. Even though there are at\nleast 4 other more popular tools, I’m a firm believer in GoCD’s vision of\npipelines as a first-class citizen. While it still lacks in some areas like the\nUI, these are being actively worked on. The project is still young, and major\nnew features are still being added in the monthly releases.</p>\n<h2>Agents and Resources</h2>\n<p>GoCD operates with one server node and multiple worker nodes. The central\nserver hosts the web interface and keeps track of pipelines and artifacts.\nWorkers check in on a specific port, and ask for jobs to run. If you’re\nthinking that this sounds like a cluster management system, you’re right! In\nfact, we use the Docker containers provided by the GoCD team, and there has\neven been some initial work done on <a href=\"https://plugin-api.go.cd/current/elastic-agents/\">elastic\nagents</a>.</p>\n<p>This approach isn’t unique to GoCD, but the tool does go a bit further with\n<strong>agent resources</strong>. Each job can be tagged with things like <code class=\"language-text\">python3-dev</code>,\n<code class=\"language-text\">windows</code> or <code class=\"language-text\">libcurl</code>. While being just text, they can be extremely powerful.\nThe server will only give a job to an agent if that agent also has those tags.\nHere’s an animation to demonstrate.</p>\n<p><img src=\"/7981666968d52e0e6feeeb6e9d444e15/delegation.gif\" alt=\"Delegation animation\" title=\"A master/worker CI system with two\ndifferent types of workers\"></p>\n<p>The white block in the lower right is the server node. The blue and purple\nblocks are agents with two different tags.</p>\n<p>During a recent refactor of our CI system, I took the opportunity to redefine\nhow these tags were set up, and what was installed on our agents. This was\nsorely needed because when we initially set our agents up, we had only just\nbegun to play with Docker. We had two different agents which were both overly\ncomplicated, had large Dockerfiles and took hours to build. So I decided to hop\nover to the opposite end of the spectrum. I was going to adopt the microservice\nphilosophy and build many agents, all of which performed one very specific\nfunction and therefore had small, easily manageable Dockerfiles.</p>\n<blockquote>\n<h1>These ‘micro-agents’ were going to be <em>amazing</em>.</h1>\n</blockquote>\n<h2>What I learned</h2>\n<p>This scheme worked great for a while. I had agents for various languages, one\nthat knew how to build Docker images, one that knew how to deploy to Google\nCloud Platform, one that could build our documentation and more…</p>\n<p>Then I came across a situation where I needed to build the documentation and\ndeploy it in the same unit of work. This was impossible, because no one agent\ncould do both tasks. While you generally want to split building and deploying,\nsometimes it just doesn’t make sense. GoCD is quite particular about what\npipelines/stages/jobs should be, and swimming against that current is a <em>very</em>\nbad idea. I know this from experience, so rewriting my pipelines by splitting\njobs up wasn’t an option.</p>\n<p>It became clear that there’s a trade-off. You either get manageable agents or\nsane pipelines. Not both.</p>\n<p>Going forward, I will always recommend that the pipelines configuration comes\nfirst. Design them without thinking about agents, and work backwards from\nthere. Afterwards, if there are groups of jobs which are mutually exclusive,\nthen create an agent type for each one. Even with this approach, you might find\nthat there are a few things which <em>all</em> agents need. Docker’s layers can help\nyou out here, because you can define a general ‘base agent’ which the other\ntypes build off.</p>\n<p>Here’s a diagram of the agents that I ended up with.</p>\n<p><figure class=\"gatsby-resp-image-figure\" style=\"\">\n    <span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 590px;\"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 61.97732104890149%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAMCAIAAADtbgqsAAAACXBIWXMAAAsSAAALEgHS3X78AAABh0lEQVQoz31Sy0rDQBTNSlSobZrMTCaTl236iA1N0oiEkIK2ixYxi4KCLv0EV/0DV3YpuHInbt0IXbnxU/Ij3kzaElrpYRjmcc495yYjKLvAWLfblutRQpS9EBRK+VDzWaEKwYphXb593/xkejzGdTG/AuQEdbXeiIksoVoFBkEy1wMI8y6c67v+INQ0jXB/XD1BtRMsVtccLtZ7/uj1K3l+J2YDSdIqeF1sW+Z4dOU4DsaYYOQ9Pk0/fu3prSzWNnqB2p1gvgjni07fbzWbKmPgDF52qxUEgWmaeRKE7PQhevnspfdNywSxjBDvGcny8aGJ5TiKut2uqqqQk1LKGCsWqyzVinR0EIeDNE3Pw9C2bWAKYMI0nRsqRXsgkDggMF0DCEzTThsNMHDOHJjhQCjYrATY+r4fRRHU3jqHcghBVEiNwEkof3q4hlOItFwusyybTCaiKEKJMmED3vMOoORwOJzNZsAge9/Jtrgwd103SRLP8wzD2KP/Xwy/N45jy7Jo6Uns4g/LZ12CpV4+pgAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Separation of concern\"\n        title=\"Separation of concern for Docker-based\nworker agents\"\n        src=\"/static/84c9d6dbb258d44e5e675bf6b4faed58/b9e4f/heirarchy.png\"\n        srcset=\"/static/84c9d6dbb258d44e5e675bf6b4faed58/cf440/heirarchy.png 148w,\n/static/84c9d6dbb258d44e5e675bf6b4faed58/d2d38/heirarchy.png 295w,\n/static/84c9d6dbb258d44e5e675bf6b4faed58/b9e4f/heirarchy.png 590w,\n/static/84c9d6dbb258d44e5e675bf6b4faed58/f9b6a/heirarchy.png 885w,\n/static/84c9d6dbb258d44e5e675bf6b4faed58/2d849/heirarchy.png 1180w,\n/static/84c9d6dbb258d44e5e675bf6b4faed58/f5882/heirarchy.png 2822w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        loading=\"lazy\"\n      />\n    </span>\n    <figcaption class=\"gatsby-resp-image-figcaption\">Separation of concern for Docker-based\nworker agents</figcaption>\n  </figure></p>\n<h2>P.S.</h2>\n<p>GoCD also has a concept of ‘environments’, which function similarly to\nresources. I did try to make use of the feature, but it didn’t quite suit my\nuse case.</p>\n<h2>More resources</h2>\n<ul>\n<li>Trends for CI tools — <a href=\"https://www.google.com/trends/explore?date=2008-01-01%202016-11-15&#x26;q=GoCD,Jenkins%20CI,Travis%20CI,Circle%20CI,Codeship\">google\ntrends</a></li>\n<li>How Dockerfiles work with layers — <a href=\"https://docs.docker.com/engine/userguide/storagedriver/imagesandcontainers/\">docker\ndocs</a></li>\n<li>GoCD Docker images — <a href=\"https://hub.docker.com/u/gocd/\">dockerhub</a>,\n<a href=\"https://github.com/gocd/gocd-docker\">github</a></li>\n<li>GoCD elastic agents — <a href=\"https://plugin-api.go.cd/current/elastic-agents/\">beta\ndocs</a></li>\n<li>Resources, jobs, stages and pipelines in GoCD — <a href=\"https://docs.go.cd/current/introduction/concepts_in_go.html\">gocd\nconcepts</a></li>\n</ul>","frontmatter":{"title":"Agent Resources in GoCD","date":"February 15, 2017"}}},"pageContext":{"slug":"/agent-resources-in-gocd/","previous":{"fields":{"slug":"/desktop-environments/"},"frontmatter":{"title":"Desktop Environments"}},"next":{"fields":{"slug":"/a-rant-about-alt-tab-in-elementary-os/"},"frontmatter":{"title":"A rant about alt+tab in elementary OS"}}}}}